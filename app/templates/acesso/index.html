{% extends "base_sidebar.html" %}
{% from 'navigation/sidebar_nav.html' import render_sidebar_nav %}

{% block sidebar_nav %}
{{ render_sidebar_nav('piscina', 'controle') }}
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/piscina-module.css') }}">
<div class="piscina-module">
    <section class="section-header">
        <h2>Controle do Acesso à Piscina</h2>
        <div class="actions">
            <a href="{{ url_for('main.acesso_qrcode') }}" class="btn btn-qr-code">
                <i class="fas fa-qrcode"></i> QR Code
            </a>
            <a href="{{ url_for('main.registrar_acesso') }}" class="btn btn-manual">
                <i class="fas fa-plus"></i> Registrar Manual
            </a>
        </div>
    </section>

    <!-- Estatísticas -->
    <section class="summary-cards">
        <div class="card card-access-info card-blue">
            <div class="icon-section"><i class="fas fa-users"></i></div>
            <div class="info-section">
                <span class="number">{{ total_dentro }}</span>
                <span class="label">Moradores na Piscina</span>
            </div>
        </div>
        <div class="card card-stats card-green">
            <div class="info-section">
                <span class="number">{{ entradas_hoje }}</span>
                <span class="label">Entradas Hoje</span>
            </div>
            <div class="icon-section"><i class="fas fa-arrow-right"></i></div>
        </div>
        <div class="card card-stats card-blue-light">
            <div class="info-section">
                <span class="number">{{ ultimos_registros|length }}</span>
                <span class="label">Últimos Registros</span>
            </div>
            <div class="icon-section"><i class="fas fa-redo"></i></div>
        </div>
        <div class="card card-stats card-yellow">
            <div class="info-section">
                <span class="label">Relatórios</span>
                <a href="{{ url_for('main.historico_acesso') }}" class="btn-history">Ver Histórico</a>
            </div>
            <div class="icon-section"><i class="fas fa-chart-line"></i></div>
        </div>
    </section>

    <section class="detailed-records-grid">
        <div class="card detailed-card card-no-access">
            {% if moradores_dentro %}
                <div class="list-group list-group-flush">
                    {% for morador in moradores_dentro %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ morador.nome_completo }}</h6>
                            <small class="text-muted">{{ morador.bloco }}-{{ morador.apartamento }}</small>
                        </div>
                        <div>
                            <a href="{{ url_for('main.processar_acesso_rapido', morador_id=morador.id, tipo='saida') }}" 
                               class="btn btn-sm btn-outline-danger"
                               onclick="return confirm('Registrar saída de {{ morador.nome_completo }}?')">
                                <i class="fas fa-sign-out-alt me-1"></i>
                                Saída
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-quote-left"></i>
                    <p>Nenhum morador na piscina no momento</p>
                </div>
            {% endif %}
        </div>
        <div class="card detailed-card card-latest-records">
            <h3>Últimos Registros</h3>
            {% if ultimos_registros %}
                {% for registro in ultimos_registros %}
                <div class="record-item">
                    <span class="name">{{ registro.morador.nome_completo }}</span>
                    <span class="time">{{ registro.data_hora.strftime('%H:%M') }}</span>
                    <span class="date">{{ registro.data_hora.strftime('%d/%m') }}</span>
                    <div class="details">
                        <span class="status status-{% if registro.tipo == 'entrada' %}entry{% else %}exit{% endif %}">
                            {% if registro.tipo == 'entrada' %}Entrada{% else %}Saída{% endif %}
                        </span> via {{ registro.metodo|title }}{% if registro.guardiao and registro.guardiao != 'Sistema QR Code' %} - {{ registro.guardiao }}{% endif %}
                    </div>
                    {% if registro.duracao_permanencia and registro.tipo == 'saida' %}
                    <div class="details-extra">Permanência: {{ registro.duracao_permanencia }}</div>
                    {% endif %}
                </div>
                {% if not loop.last %}
                <hr>
                {% endif %}
                {% endfor %}
                <a href="{{ url_for('main.historico_acesso') }}" class="btn btn-full-history">Ver Histórico Completo</a>
            {% else %}
                <p>Nenhum registro encontrado</p>
            {% endif %}
        </div>
    </section>

    <!-- Ações Rápidas -->
    <section class="quick-actions">
        <a href="{{ url_for('main.controle_acesso') }}" class="quick-action-card card-grey">
            <i class="fas fa-fingerprint"></i>
            <span>Acesso automático</span>
        </a>
        <a href="{{ url_for('main.registrar_acesso') }}" class="quick-action-card card-green-light">
            <i class="fas fa-edit"></i>
            <span>Registro Manual</span>
            <small>Entrada/saída manual</small>
        </a>
        <a href="{{ url_for('main.historico_acesso') }}" class="quick-action-card card-blue-light">
            <i class="fas fa-chart-bar"></i>
            <span>Relatórios</span>
            <small>Histórico e estatísticas</small>
        </a>
        <a href="{{ url_for('main.listar_moradores') }}" class="quick-action-card card-yellow-light">
            <i class="fas fa-users"></i>
            <span>Moradores</span>
            <small>Gerenciar carteirinhas</small>
        </a>
    </section>
</div>

<script>
// Auto-refresh da página a cada 30 segundos
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %} 